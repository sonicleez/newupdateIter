# ðŸ” PERFORMANCE AUDIT REPORT
## Genyu Scene Director - Vercel Deployment

**NgÃ y audit:** 2026-01-14
**BÃ¡o cÃ¡o bá»Ÿi:** Antigravity AI

---

## ðŸ“Š BUNDLE SIZE ANALYSIS

| File | Size | Gzip | ÄÃ¡nh giÃ¡ |
|------|------|------|----------|
| `index.js` | 585 KB | 178 KB | âš ï¸ Lá»šN |
| `app-modals.js` | 715 KB | 227 KB | ðŸ”´ QUÃ Lá»šN |
| `vendor-ai.js` | 255 KB | 51 KB | OK |
| `vendor-supabase.js` | 171 KB | 44 KB | OK |
| **TOTAL** | **~1.7 MB** | **~500 KB** | ðŸ”´ Cáº¦N Tá»I Æ¯U |

### Khuyáº¿n nghá»‹:
- Bundle `app-modals.js` (715 KB) quÃ¡ lá»›n - cáº§n lazy load cÃ¡c modals
- Total gzip 500KB â†’ First load cháº­m trÃªn máº¡ng yáº¿u

---

## âš¡ Váº¤N Äá»€ PERFORMANCE TÃŒM THáº¤Y

### 1. ðŸ”´ QUÃ NHIá»€U useEffect TRÃŠN MOUNT (6+ effects trong App.tsx)

```tsx
// App.tsx cÃ³ 6+ useEffect cháº¡y khi mount:
- Line 529: Scroll listener
- Line 540: Supabase key fetch + Realtime
- Line 630: Sync Usage Stats from Cloud â† BLOCKING
- Line 646: Sync Director Brain â† BLOCKING
- Line 657: Load Gommo Credentials â† BLOCKING
- Line 700: Hot reload handler
```

**Váº¥n Ä‘á»:** Táº¥t cáº£ effects cháº¡y Ä‘á»“ng thá»i khi component mount â†’ waterfall requests â†’ UI bá»‹ block.

**Fix:**
```tsx
// Gá»™p cÃ¡c API calls vÃ o 1 effect vá»›i Promise.all
useEffect(() => {
  const initializeApp = async () => {
    if (!session?.user?.id) return;
    
    const [stats, _, gommo] = await Promise.all([
      fetchUserStatsFromCloud(session.user.id),
      syncDirectorBrain(session.user.id),
      loadGommoCredentials(session.user.id)
    ]);
    
    // Update state once
    updateStateAndRecord(s => ({ ...s, usageStats: stats, ... }));
  };
  initializeApp();
}, [session?.user?.id]);
```

---

### 2. ðŸ”´ Táº O NHIá»€U GoogleGenAI INSTANCES

TÃ¬m tháº¥y **60+ nÆ¡i** táº¡o `new GoogleGenAI({ apiKey })`.

**Váº¥n Ä‘á»:** Má»—i láº§n gá»i API láº¡i táº¡o instance má»›i â†’ memory overhead.

**Fix:** Táº¡o singleton:
```tsx
// utils/geminiClient.ts
let aiInstance: GoogleGenAI | null = null;
let cachedApiKey: string | null = null;

export function getGeminiClient(apiKey: string): GoogleGenAI {
  if (!aiInstance || cachedApiKey !== apiKey) {
    aiInstance = new GoogleGenAI({ apiKey: apiKey.trim() });
    cachedApiKey = apiKey;
  }
  return aiInstance;
}
```

---

### 3. ðŸŸ¡ MODALS KHÃ”NG ÄÆ¯á»¢C LAZY LOAD

`app-modals.js` chiáº¿m **715 KB** - load ngay láº­p tá»©c dÃ¹ user chÆ°a má»Ÿ modal nÃ o.

**Fix:** Lazy load modals:
```tsx
const ImageEditorModal = lazy(() => import('./modals/ImageEditorModal'));
const ScriptGeneratorModal = lazy(() => import('./modals/ScriptGeneratorModal'));
// ...

<Suspense fallback={<Loading />}>
  {isEditorOpen && <ImageEditorModal />}
</Suspense>
```

---

### 4. ðŸŸ¡ LOCALSTORAGE PARSE TRÃŠN RENDER

```tsx
// CÃ¡c component parse JSON tá»« localStorage TRÃŠN Má»–I RENDER
const [position] = useState(() => {
  const saved = localStorage.getItem('position');
  return saved ? JSON.parse(saved) : defaultValue; // â† Parse má»—i khi re-render state
});
```

**OK** vÃ¬ Ä‘Ã£ dÃ¹ng lazy initial state, nhÆ°ng kiá»ƒm tra khÃ´ng cÃ³ JSON.parse ngoÃ i useState.

---

### 5. ðŸŸ¡ SUPABASE REALTIME CHANNEL

```tsx
// App.tsx line 600+
const channel = supabase.channel('user_api_keys_changes')...
```

**Váº¥n Ä‘á»:** Realtime subscription active liÃªn tá»¥c â†’ WebSocket connection â†’ battery drain trÃªn mobile.

**Fix:** Chá»‰ subscribe khi cáº§n, hoáº·c dÃ¹ng polling thay tháº¿.

---

### 6. ðŸŸ¡ LARGE STATE OBJECT

`ProjectState` chá»©a `scenes[]` vá»›i `generatedImage` (base64) â†’ Object ráº¥t lá»›n.

**Váº¥n Ä‘á»:** Má»—i láº§n `updateStateAndRecord()` â†’ serialize ~MBs data.

**Fix:** 
- TÃ¡ch images ra khá»i state chÃ­nh
- DÃ¹ng IndexedDB cho images
- State chá»‰ giá»¯ URLs/IDs

---

## ðŸ› ï¸ QUICK WINS (LÃ m ngay)

### Priority 1: Gá»™p useEffect calls
```tsx
// TrÆ°á»›c: 4 useEffect riÃªng láº»
// Sau: 1 useEffect vá»›i Promise.all
```

### Priority 2: Lazy load modals
```tsx
const HeavyModal = lazy(() => import('./HeavyModal'));
```

### Priority 3: Singleton Gemini client
```tsx
export const getGeminiClient = (apiKey) => { ... }
```

### Priority 4: Virtualize scene lists (náº¿u >50 scenes)
```tsx
import { FixedSizeList } from 'react-window';
```

---

## ðŸ“ˆ EXPECTED IMPROVEMENTS

| Metric | TrÆ°á»›c | Sau (estimated) |
|--------|-------|-----------------|
| First Contentful Paint | ~3s | ~1.5s |
| Time to Interactive | ~5s | ~2.5s |
| Bundle (gzip) | 500KB | ~300KB |
| Memory usage | High | -40% |

---

## ðŸ”§ IMPLEMENTATION PLAN

### Phase 1 (Ngay láº­p tá»©c):
1. âœ… Gá»™p useEffect calls vÃ o 1 init function
2. âœ… Táº¡o Gemini singleton

### Phase 2 (Tuáº§n nÃ y):
3. âœ… Lazy load modals
4. âœ… Code-split heavy components

### Phase 3 (Sau):
5. âœ… Move images to IndexedDB
6. âœ… Virtualize long lists

---

*Report generated by Antigravity AI*
